{% extends "bootstrap/base.html" %}

{% block title %}
Demo App
{% endblock %}

{% block styles %}
{{super()}}
<link rel="stylesheet" href="{{url_for('.static', filename='starter-template.css')}}">

    
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

<script>
var urls = "";
var ctx = null; 

function add_rect(line){
  //TODO darw cat different color
  ctx.strokeStyle = 'blue';
  var elems=line.split(" ")
  ctx.strokeRect(elems[1]*500-elems[3]*500/2, elems[2]*500-elems[4]*500/2, elems[3]*500, elems[4]*500);

}


$.get('/static/files.txt', function(data) {
   urls=data;
   elems=urls.split("\n");
   innerhtml="";

   for(i=0; i<20; i++){//pagnation TODO
     innerhtml+="<img class='thumbs' width=60 height=60 id='img"+i+"' src='"+elems[i]+"'>";
   }
   $("#imgs_div").html(innerhtml);

    $(".thumbs").on("click", function()
    {

      console.log(this.id);
      image_url=$("#"+this.id).attr('src');
      txt_url="";
      if (image_url.indexOf(".jpg") > -1) {
         txt_url = image_url.replace('.jpg','.txt' );
      }else{
         //nothing yet
      }
      console.log(txt_url);
      init(image_url); 
      $.get(txt_url, function(data) {
        
        $("#mark_box").html(data);
        $("#infobox").html(data);
        
        lines=data.split("\n");
          for(var i=0; i<lines.length; i++){
            add_rect(lines[i]);
          
          }
      }).fail(function(){ 
        $("#mark_box").html("");
        $("#infobox").html("");
        //error
      });
    });
  

    var canvas = document.getElementById('canvas');
    var txt= document.getElementById('infobox');
    ctx = canvas.getContext('2d');
    var rect = {};
    var rects =[];
    var drag = false;
    var imageObj = null;
    var curr_rect_idx=0;

    function init(url) {
        imageObj = new Image();
        ctx.clearRect(0, 0, 500, 500);
        imageObj.onload = function () { 
          ctx.drawImage(imageObj, 0, 0); 
          ctx.drawImage(imageObj, 0, 0, imageObj.width,    imageObj.height,     // source rectangle
                   0, 0, canvas.width, canvas.height);
        };
        imageObj.src = url;
        canvas.addEventListener('mousedown', mouseDown, false);
        canvas.addEventListener('mouseup', mouseUp, false);
        canvas.addEventListener('mousemove', mouseMove, false);
    }

    function mouseDown(e) {
        var rect={};
        rect.startX = e.pageX - this.offsetLeft;
        rect.startY = e.pageY - this.offsetTop;
        rects[curr_rect_idx]=rect;
        drag = true;
    }

    function mouseUp() { 
      drag = false; 
      curr_rect_idx++;

    }

    function mouseMove(e) {
        if (drag) {
            //ctx.clearRect(0, 0, 500, 500);

            ctx.drawImage(imageObj, 0, 0);
            rects[curr_rect_idx].w = (e.pageX - this.offsetLeft) - rects[curr_rect_idx].startX;
            rects[curr_rect_idx].h = (e.pageY - this.offsetTop) - rects[curr_rect_idx].startY;
            ctx.strokeStyle = 'red';
            txt.innerHTML="";
            for(i=0; i<=curr_rect_idx; i++){
              ctx.strokeRect(rects[i].startX, rects[i].startY, rects[i].w, rects[i].h);
              txt.innerHTML+=rects[i].startX/500+", "+ rects[i].startY/400+", " + rects[i].w/500 + ", " + rects[i].h/400+"\n" ;
            }
            
        }
    }

}, 'text');

</script>
{% endblock %}

{% block content %}
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">WEB YOLO MARK</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="{{ url_for('login') }}">Login</a></li>
            <li><a href="{{ url_for('signup') }}">Sign Up</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <div class="split left">
        <div id="canvas_div" class="canvas0">
          <canvas id="canvas" width="500" height="500"></canvas>
        </div>  
        <div id="imgs_div" class="images">
          
            <img src="" alt="">
          
        </div>
      </div>

      <div class="split right">
        <div class="centered">
          <img src="img_avatar.png" alt="Avatar man">
          <pre>
            <p id="mark_box">EMPTY</p>
          </pre>
          <pre>
          <p id="infobox">Some text here too.</p>
          </pre>
        </div>
      </div>
   </div><!-- /.container -->

{% endblock %}


